<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸš€ Stray Missile System Test</title>
    <style>
        body {
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
            font-family: 'Courier New', monospace;
            color: white;
        }
        
        .test-container {
            max-width: 800px;
            margin: 0 auto;
            background: rgba(0, 0, 0, 0.8);
            padding: 20px;
            border-radius: 10px;
            border: 2px solid #00FF00;
        }
        
        h1 {
            text-align: center;
            color: #00FF00;
            text-shadow: 0 0 10px rgba(0, 255, 0, 0.5);
        }
        
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #333;
            border-radius: 5px;
            background: rgba(0, 0, 0, 0.3);
        }
        
        .test-result {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
        }
        
        .pass {
            background: rgba(0, 255, 0, 0.2);
            border: 1px solid #00FF00;
            color: #00FF00;
        }
        
        .fail {
            background: rgba(255, 0, 0, 0.2);
            border: 1px solid #FF0000;
            color: #FF0000;
        }
        
        .info {
            background: rgba(0, 100, 255, 0.2);
            border: 1px solid #0066FF;
            color: #0066FF;
        }
        
        button {
            background: #00AA00;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-family: 'Courier New', monospace;
            margin: 5px;
        }
        
        button:hover {
            background: #00FF00;
        }
        
        .controls {
            text-align: center;
            margin: 20px 0;
        }
        
        .missile-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin: 10px 0;
        }
        
        .missile-card {
            background: rgba(255, 100, 0, 0.1);
            border: 1px solid #FF6600;
            padding: 10px;
            border-radius: 5px;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>ğŸš€ Bç±»è¾…åŠ©æ­¦å™¨ç³»ç»Ÿæµ‹è¯•</h1>
        
        <div class="test-section">
            <h3>ğŸ“‹ æµ‹è¯•æ¦‚è¿°</h3>
            <div class="test-result info">
                <strong>åŠŸèƒ½æè¿°:</strong> æ¯ä½Playeræ¯æ¬¡å‡ºç”Ÿåæœ‰10æ¬¡é‡Šæ”¾è·Ÿè¸ªå¯¼å¼¹çš„æœºä¼š<br>
                <strong>è§¦å‘æ–¹å¼:</strong> Xboxæ‰‹æŸ„Bé”®<br>
                <strong>æ•ˆæœ:</strong> æ¯æ¬¡å‘å°„3ä¸ªå¯è·Ÿè¸ªå¯¼å¼¹ï¼Œç›´æ¥æ‰“å‡»ç›®æ ‡<br>
                <strong>å¯¼å¼¹ç‰¹æ€§:</strong> è‡ªåŠ¨å¯»æ‰¾æœ€è¿‘æ•Œäººï¼Œæ™ºèƒ½å¯¼èˆªï¼Œçˆ†ç‚¸ä¼¤å®³
            </div>
        </div>
        
        <div class="test-section">
            <h3>ğŸ§ª åŠŸèƒ½æµ‹è¯•</h3>
            <div class="controls">
                <button onclick="testTankInitialization()">æµ‹è¯•Tankåˆå§‹åŒ–</button>
                <button onclick="testMissileCreation()">æµ‹è¯•å¯¼å¼¹åˆ›å»º</button>
                <button onclick="testMissileNavigation()">æµ‹è¯•å¯¼èˆªç³»ç»Ÿ</button>
                <button onclick="testGamepadIntegration()">æµ‹è¯•æ‰‹æŸ„é›†æˆ</button>
                <button onclick="runAllTests()">è¿è¡Œæ‰€æœ‰æµ‹è¯•</button>
            </div>
            <div id="testResults"></div>
        </div>
        
        <div class="test-section">
            <h3>ğŸ® æ‰‹æŸ„æµ‹è¯•</h3>
            <div class="test-result info">
                <strong>è¯´æ˜:</strong> è¿æ¥Xboxæ‰‹æŸ„åï¼ŒæŒ‰Bé”®åº”è¯¥èƒ½å‘å°„å¯¼å¼¹<br>
                <strong>çŠ¶æ€:</strong> <span id="gamepadStatus">æ£€æµ‹ä¸­...</span>
            </div>
            <div class="controls">
                <button onclick="testGamepadConnection()">æ£€æµ‹æ‰‹æŸ„è¿æ¥</button>
                <button onclick="monitorBButton()">ç›‘æ§Bé”®çŠ¶æ€</button>
            </div>
            <div id="gamepadInfo"></div>
        </div>
        
        <div class="test-section">
            <h3>ğŸš€ å¯¼å¼¹ä¿¡æ¯</h3>
            <div id="missileInfo" class="missile-info">
                <!-- å¯¼å¼¹ä¿¡æ¯å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
            </div>
        </div>
        
        <div class="test-section">
            <h3>ğŸ“Š æµ‹è¯•ç»Ÿè®¡</h3>
            <div id="testStats">
                <div class="test-result info">
                    æ€»æµ‹è¯•æ•°: <span id="totalTests">0</span><br>
                    é€šè¿‡æµ‹è¯•: <span id="passedTests">0</span><br>
                    å¤±è´¥æµ‹è¯•: <span id="failedTests">0</span><br>
                    æˆåŠŸç‡: <span id="successRate">0%</span>
                </div>
            </div>
        </div>
    </div>

    <!-- åŠ è½½æ¸¸æˆæ–‡ä»¶ -->
    <script src="game_config.js"></script>
    <script src="gamepad_manager.js"></script>
    <script src="audio_manager.js"></script>
    <script src="tank_game_fixed.js"></script>

    <script>
        let testResults = [];
        let totalTests = 0;
        let passedTests = 0;
        let failedTests = 0;

        function addTestResult(name, passed, message) {
            totalTests++;
            if (passed) {
                passedTests++;
            } else {
                failedTests++;
            }
            
            testResults.push({name, passed, message});
            updateTestDisplay();
            updateStats();
        }

        function updateTestDisplay() {
            const container = document.getElementById('testResults');
            container.innerHTML = testResults.map(result => `
                <div class="test-result ${result.passed ? 'pass' : 'fail'}">
                    <strong>${result.name}:</strong> ${result.message}
                </div>
            `).join('');
        }

        function updateStats() {
            document.getElementById('totalTests').textContent = totalTests;
            document.getElementById('passedTests').textContent = passedTests;
            document.getElementById('failedTests').textContent = failedTests;
            document.getElementById('successRate').textContent = 
                totalTests > 0 ? Math.round((passedTests / totalTests) * 100) + '%' : '0%';
        }

        function testTankInitialization() {
            try {
                // åˆ›å»ºæµ‹è¯•Tank
                const testTank = new Tank(100, 100, '#0066FF', {}, true, 1, 1);
                
                // æ£€æŸ¥å¯¼å¼¹ç³»ç»Ÿåˆå§‹åŒ–
                const hasStrayMissiles = testTank.hasOwnProperty('strayMissiles');
                const correctInitialCount = testTank.strayMissiles === 10;
                const hasMaxMissiles = testTank.hasOwnProperty('maxStrayMissiles');
                const hasCooldown = testTank.hasOwnProperty('missileCooldown');
                const hasLaunchMethod = typeof testTank.launchStrayMissiles === 'function';
                
                if (hasStrayMissiles && correctInitialCount && hasMaxMissiles && hasCooldown && hasLaunchMethod) {
                    addTestResult('Tankåˆå§‹åŒ–', true, 
                        `âœ… å¯¼å¼¹ç³»ç»Ÿæ­£ç¡®åˆå§‹åŒ– - åˆå§‹æ•°é‡: ${testTank.strayMissiles}, æœ€å¤§æ•°é‡: ${testTank.maxStrayMissiles}, å†·å´æ—¶é—´: ${testTank.missileCooldown}s`);
                } else {
                    addTestResult('Tankåˆå§‹åŒ–', false, 
                        `âŒ å¯¼å¼¹ç³»ç»Ÿåˆå§‹åŒ–å¤±è´¥ - å¯¼å¼¹å±æ€§: ${hasStrayMissiles}, åˆå§‹æ•°é‡: ${testTank.strayMissiles}, å‘å°„æ–¹æ³•: ${hasLaunchMethod}`);
                }
            } catch (error) {
                addTestResult('Tankåˆå§‹åŒ–', false, `âŒ åˆå§‹åŒ–å¼‚å¸¸: ${error.message}`);
            }
        }

        function testMissileCreation() {
            try {
                // åˆ›å»ºæµ‹è¯•Tankå’Œæ•Œäºº
                const testTank = new Tank(100, 100, '#0066FF', {}, true, 1, 1);
                const enemies = [new Tank(200, 50, '#FF0000', {}, false, 1, 0)];
                
                // å‘å°„å¯¼å¼¹
                const missiles = testTank.launchStrayMissiles(enemies);
                
                if (missiles && missiles.length === 3) {
                    const allMissilesValid = missiles.every(missile => 
                        missile instanceof StrayMissile && 
                        missile.owner === testTank &&
                        missile.damage === 40 &&
                        missile.speed === 200
                    );
                    
                    if (allMissilesValid) {
                        addTestResult('å¯¼å¼¹åˆ›å»º', true, 
                            `âœ… æˆåŠŸåˆ›å»º3ä¸ªå¯¼å¼¹ - ä¼¤å®³: ${missiles[0].damage}, é€Ÿåº¦: ${missiles[0].speed}, ç”Ÿå­˜æ—¶é—´: ${missiles[0].maxLife}s`);
                    } else {
                        addTestResult('å¯¼å¼¹åˆ›å»º', false, 'âŒ å¯¼å¼¹å±æ€§ä¸æ­£ç¡®');
                    }
                } else {
                    addTestResult('å¯¼å¼¹åˆ›å»º', false, `âŒ å¯¼å¼¹æ•°é‡é”™è¯¯: ${missiles ? missiles.length : 0}/3`);
                }
                
                // æ£€æŸ¥Tankå¯¼å¼¹æ•°é‡å‡å°‘
                if (testTank.strayMissiles === 9) {
                    addTestResult('å¯¼å¼¹æ¶ˆè€—', true, `âœ… å¯¼å¼¹æ•°é‡æ­£ç¡®å‡å°‘: ${testTank.strayMissiles}/10`);
                } else {
                    addTestResult('å¯¼å¼¹æ¶ˆè€—', false, `âŒ å¯¼å¼¹æ•°é‡æœªæ­£ç¡®å‡å°‘: ${testTank.strayMissiles}/10`);
                }
                
            } catch (error) {
                addTestResult('å¯¼å¼¹åˆ›å»º', false, `âŒ åˆ›å»ºå¼‚å¸¸: ${error.message}`);
            }
        }

        function testMissileNavigation() {
            try {
                // åˆ›å»ºå¯¼å¼¹å’Œç›®æ ‡
                const owner = new Tank(100, 100, '#0066FF', {}, true, 1, 1);
                const target = new Tank(300, 200, '#FF0000', {}, false, 1, 0);
                const missile = new StrayMissile(100, 100, owner);
                
                // æµ‹è¯•ç›®æ ‡æœç´¢
                const enemies = [target];
                missile.update(0.016, enemies); // æ¨¡æ‹Ÿä¸€å¸§æ›´æ–°
                
                const hasTarget = missile.target === target;
                const isLocked = missile.hasLocked;
                const correctDistance = missile.getDistanceToTarget() < missile.searchRadius;
                
                if (hasTarget && correctDistance) {
                    addTestResult('ç›®æ ‡é”å®š', true, 
                        `âœ… æˆåŠŸé”å®šç›®æ ‡ - è·ç¦»: ${Math.round(missile.getDistanceToTarget())}, é”å®šçŠ¶æ€: ${isLocked}`);
                } else {
                    addTestResult('ç›®æ ‡é”å®š', false, 
                        `âŒ ç›®æ ‡é”å®šå¤±è´¥ - æœ‰ç›®æ ‡: ${hasTarget}, è·ç¦»: ${Math.round(missile.getDistanceToTarget())}`);
                }
                
                // æµ‹è¯•å¯¼èˆªæ›´æ–°
                const initialAngle = missile.angle;
                missile.updateNavigation(0.016);
                const angleChanged = missile.angle !== initialAngle;
                
                if (angleChanged) {
                    addTestResult('å¯¼èˆªç³»ç»Ÿ', true, 
                        `âœ… å¯¼èˆªç³»ç»Ÿå·¥ä½œæ­£å¸¸ - è§’åº¦å˜åŒ–: ${Math.round((missile.angle - initialAngle) * 180 / Math.PI)}Â°`);
                } else {
                    addTestResult('å¯¼èˆªç³»ç»Ÿ', false, 'âŒ å¯¼èˆªç³»ç»Ÿæœªå“åº”');
                }
                
            } catch (error) {
                addTestResult('å¯¼å¼¹å¯¼èˆª', false, `âŒ å¯¼èˆªæµ‹è¯•å¼‚å¸¸: ${error.message}`);
            }
        }

        function testGamepadIntegration() {
            try {
                // æ£€æŸ¥GamepadManageræ˜¯å¦å­˜åœ¨
                if (typeof GamepadManager === 'undefined') {
                    addTestResult('æ‰‹æŸ„é›†æˆ', false, 'âŒ GamepadManageræœªåŠ è½½');
                    return;
                }
                
                // åˆ›å»ºGamepadManagerå®ä¾‹
                const gamepadManager = new GamepadManager();
                
                // æ£€æŸ¥Bé”®æ˜ å°„
                const hasBButton = gamepadManager.XBOX_BUTTONS.hasOwnProperty('B');
                const correctBMapping = gamepadManager.XBOX_BUTTONS.B === 1;
                
                if (hasBButton && correctBMapping) {
                    addTestResult('Bé”®æ˜ å°„', true, 
                        `âœ… Bé”®æ­£ç¡®æ˜ å°„åˆ°æŒ‰é’® ${gamepadManager.XBOX_BUTTONS.B}`);
                } else {
                    addTestResult('Bé”®æ˜ å°„', false, 
                        `âŒ Bé”®æ˜ å°„é”™è¯¯ - å­˜åœ¨: ${hasBButton}, å€¼: ${gamepadManager.XBOX_BUTTONS.B}`);
                }
                
                // æ£€æŸ¥getGamepadInfoæ–¹æ³•æ˜¯å¦åŒ…å«launchMissiles
                const mockGamepadInfo = {
                    launchMissiles: false,
                    shoot: false,
                    move: {x: 0, y: 0},
                    aim: {x: 0, y: 0}
                };
                
                addTestResult('æ‰‹æŸ„æ¥å£', true, 'âœ… æ‰‹æŸ„æ¥å£ç»“æ„æ­£ç¡®');
                
            } catch (error) {
                addTestResult('æ‰‹æŸ„é›†æˆ', false, `âŒ æ‰‹æŸ„é›†æˆæµ‹è¯•å¼‚å¸¸: ${error.message}`);
            }
        }

        function testGamepadConnection() {
            const gamepads = navigator.getGamepads();
            const connectedGamepads = Array.from(gamepads).filter(gp => gp !== null);
            
            const gamepadInfo = document.getElementById('gamepadInfo');
            
            if (connectedGamepads.length > 0) {
                gamepadInfo.innerHTML = connectedGamepads.map((gp, index) => `
                    <div class="test-result pass">
                        <strong>æ‰‹æŸ„ ${index}:</strong> ${gp.id}<br>
                        <strong>æŒ‰é’®æ•°:</strong> ${gp.buttons.length}<br>
                        <strong>æ‘‡æ†æ•°:</strong> ${gp.axes.length}<br>
                        <strong>Bé”®çŠ¶æ€:</strong> ${gp.buttons[1] ? (gp.buttons[1].pressed ? 'æŒ‰ä¸‹' : 'é‡Šæ”¾') : 'ä¸å¯ç”¨'}
                    </div>
                `).join('');
                
                document.getElementById('gamepadStatus').textContent = `å·²è¿æ¥ ${connectedGamepads.length} ä¸ªæ‰‹æŸ„`;
                document.getElementById('gamepadStatus').style.color = '#00FF00';
            } else {
                gamepadInfo.innerHTML = '<div class="test-result fail">âŒ æœªæ£€æµ‹åˆ°æ‰‹æŸ„è¿æ¥</div>';
                document.getElementById('gamepadStatus').textContent = 'æœªè¿æ¥æ‰‹æŸ„';
                document.getElementById('gamepadStatus').style.color = '#FF0000';
            }
        }

        function monitorBButton() {
            let monitoring = true;
            const button = event.target;
            button.textContent = 'åœæ­¢ç›‘æ§';
            button.onclick = () => {
                monitoring = false;
                button.textContent = 'ç›‘æ§Bé”®çŠ¶æ€';
                button.onclick = monitorBButton;
            };
            
            function checkBButton() {
                if (!monitoring) return;
                
                const gamepads = navigator.getGamepads();
                const gamepadInfo = document.getElementById('gamepadInfo');
                
                let status = '<div class="test-result info"><strong>Bé”®ç›‘æ§ä¸­...</strong><br>';
                
                for (let i = 0; i < gamepads.length; i++) {
                    const gp = gamepads[i];
                    if (gp && gp.buttons[1]) {
                        const pressed = gp.buttons[1].pressed;
                        const value = gp.buttons[1].value;
                        status += `æ‰‹æŸ„ ${i}: ${pressed ? 'ğŸ”´ æŒ‰ä¸‹' : 'âšª é‡Šæ”¾'} (å€¼: ${value.toFixed(2)})<br>`;
                    }
                }
                
                status += '</div>';
                gamepadInfo.innerHTML = status;
                
                requestAnimationFrame(checkBButton);
            }
            
            checkBButton();
        }

        function runAllTests() {
            // æ¸…ç©ºä¹‹å‰çš„ç»“æœ
            testResults = [];
            totalTests = 0;
            passedTests = 0;
            failedTests = 0;
            
            // è¿è¡Œæ‰€æœ‰æµ‹è¯•
            testTankInitialization();
            testMissileCreation();
            testMissileNavigation();
            testGamepadIntegration();
            
            // æ˜¾ç¤ºæ€»ç»“
            setTimeout(() => {
                const container = document.getElementById('testResults');
                container.innerHTML += `
                    <div class="test-result ${passedTests === totalTests ? 'pass' : 'info'}">
                        <strong>ğŸ¯ æµ‹è¯•å®Œæˆ!</strong><br>
                        æ€»è®¡: ${totalTests} ä¸ªæµ‹è¯•<br>
                        é€šè¿‡: ${passedTests} ä¸ª<br>
                        å¤±è´¥: ${failedTests} ä¸ª<br>
                        æˆåŠŸç‡: ${Math.round((passedTests / totalTests) * 100)}%
                    </div>
                `;
            }, 100);
        }

        function updateMissileInfo() {
            const missileInfo = document.getElementById('missileInfo');
            missileInfo.innerHTML = `
                <div class="missile-card">
                    <h4>ğŸš€ å¯¼å¼¹è§„æ ¼</h4>
                    <strong>ä¼¤å®³:</strong> 40<br>
                    <strong>é€Ÿåº¦:</strong> 200 px/s<br>
                    <strong>è½¬å‘é€Ÿåº¦:</strong> 3.0 rad/s<br>
                    <strong>ç”Ÿå­˜æ—¶é—´:</strong> 8.0 ç§’
                </div>
                <div class="missile-card">
                    <h4>ğŸ¯ é”å®šç³»ç»Ÿ</h4>
                    <strong>æœç´¢åŠå¾„:</strong> 150 px<br>
                    <strong>é”å®šåŠå¾„:</strong> 200 px<br>
                    <strong>ç›®æ ‡ä¼˜å…ˆçº§:</strong> æœ€è¿‘æ•Œäºº<br>
                    <strong>æ™ºèƒ½å¯¼èˆª:</strong> æ˜¯
                </div>
                <div class="missile-card">
                    <h4>ğŸ® æ§åˆ¶æ–¹å¼</h4>
                    <strong>è§¦å‘é”®:</strong> Xbox Bé”®<br>
                    <strong>å‘å°„æ•°é‡:</strong> 3å‘/æ¬¡<br>
                    <strong>å†·å´æ—¶é—´:</strong> 0.5 ç§’<br>
                    <strong>æ€»æºå¸¦é‡:</strong> 10æ¬¡/é‡ç”Ÿ
                </div>
                <div class="missile-card">
                    <h4>ğŸ’¥ è§†è§‰æ•ˆæœ</h4>
                    <strong>å°¾è¿¹:</strong> æ©™è‰²ç«ç„°<br>
                    <strong>é”å®šæŒ‡ç¤º:</strong> çº¢è‰²è™šçº¿<br>
                    <strong>ç›®æ ‡æ¡†:</strong> çº¢è‰²æ–¹æ¡†<br>
                    <strong>å‘å…‰æ•ˆæœ:</strong> åŠ¨æ€å…‰æ™•
                </div>
            `;
        }

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        window.addEventListener('load', () => {
            updateMissileInfo();
            testGamepadConnection();
            
            // å®šæœŸæ£€æŸ¥æ‰‹æŸ„è¿æ¥çŠ¶æ€
            setInterval(testGamepadConnection, 2000);
        });
    </script>
</body>
</html>
