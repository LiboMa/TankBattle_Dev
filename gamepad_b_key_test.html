<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ® æ‰‹æŸ„Bé”®æµ‹è¯•</title>
    <style>
        body {
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #1e3c72, #2a5298);
            font-family: 'Courier New', monospace;
            color: white;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
        }
        
        h1 {
            text-align: center;
            color: #FFD700;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }
        
        .test-section {
            background: rgba(0,0,0,0.3);
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            border: 2px solid #FFD700;
        }
        
        .status {
            font-size: 18px;
            text-align: center;
            padding: 20px;
            margin: 10px 0;
            border-radius: 8px;
            background: rgba(255,255,255,0.1);
        }
        
        .btn {
            background: linear-gradient(45deg, #FF6600, #FF8800);
            color: white;
            border: none;
            padding: 10px 20px;
            margin: 5px;
            border-radius: 5px;
            cursor: pointer;
            font-family: inherit;
            font-weight: bold;
        }
        
        .btn:hover {
            background: linear-gradient(45deg, #FF8800, #FFAA00);
        }
        
        .controls {
            text-align: center;
            margin: 20px 0;
        }
        
        .log {
            background: #000;
            color: #00FF00;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            height: 200px;
            overflow-y: auto;
            margin: 20px 0;
        }
        
        .success { color: #00FF00; }
        .error { color: #FF4444; }
        .warning { color: #FFAA00; }
        .info { color: #00AAFF; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ® æ‰‹æŸ„Bé”®å¯¼å¼¹å‘å°„æµ‹è¯•</h1>
        
        <div class="test-section">
            <h3>ğŸ” æ‰‹æŸ„è¿æ¥çŠ¶æ€</h3>
            <div id="connectionStatus" class="status">æ£€æµ‹ä¸­...</div>
            <div class="controls">
                <button class="btn" onclick="checkGamepads()">ğŸ”„ åˆ·æ–°æ£€æµ‹</button>
            </div>
        </div>
        
        <div class="test-section">
            <h3>ğŸ…±ï¸ Bé”®æµ‹è¯•</h3>
            <div id="bKeyStatus" class="status">ç­‰å¾…æŒ‰é”®...</div>
            <div id="rtTriggerStatus" class="status">ç­‰å¾…æ‰³æœº...</div>
            <div id="launchMissileStatus" class="status">å¯¼å¼¹å‘å°„çŠ¶æ€: å¾…å‘½</div>
        </div>
        
        <div class="test-section">
            <h3>ğŸ“Š å®æ—¶æ—¥å¿—</h3>
            <div id="testLog" class="log"></div>
            <div class="controls">
                <button class="btn" onclick="clearLog()">ğŸ—‘ï¸ æ¸…ç©ºæ—¥å¿—</button>
                <button class="btn" onclick="startTest()">ğŸš€ å¼€å§‹æµ‹è¯•</button>
                <button class="btn" onclick="stopTest()">â¹ï¸ åœæ­¢æµ‹è¯•</button>
            </div>
        </div>
        
        <div class="test-section">
            <h3>ğŸ“‹ æµ‹è¯•è¯´æ˜</h3>
            <ul>
                <li>è¿æ¥Xboxæ‰‹æŸ„åˆ°ç”µè„‘</li>
                <li>æŒ‰ä¸‹æ‰‹æŸ„ä¸Šçš„BæŒ‰é’®</li>
                <li>æŒ‰ä¸‹æ‰‹æŸ„ä¸Šçš„RTæ‰³æœº</li>
                <li>è§‚å¯Ÿæ—¥å¿—ä¸­çš„å“åº”</li>
                <li>ç¡®è®¤å¯¼å¼¹å‘å°„çŠ¶æ€å˜åŒ–</li>
            </ul>
        </div>
    </div>

    <script src="gamepad_manager.js"></script>
    <script>
        let gamepadManager = null;
        let testInterval = null;
        let logCount = 0;

        // åˆå§‹åŒ–
        function init() {
            try {
                gamepadManager = new GamepadManager();
                log('âœ… GamepadManager åˆå§‹åŒ–æˆåŠŸ', 'success');
                checkGamepads();
                startTest();
            } catch (error) {
                log('âŒ GamepadManager åˆå§‹åŒ–å¤±è´¥: ' + error.message, 'error');
            }
        }

        // æ£€æŸ¥æ‰‹æŸ„è¿æ¥
        function checkGamepads() {
            if (!gamepadManager) {
                log('âŒ GamepadManager æœªåˆå§‹åŒ–', 'error');
                return;
            }

            gamepadManager.update();
            const connectedCount = gamepadManager.getConnectedGamepadCount();
            
            const statusDiv = document.getElementById('connectionStatus');
            if (connectedCount > 0) {
                statusDiv.innerHTML = `âœ… å·²è¿æ¥ ${connectedCount} ä¸ªæ‰‹æŸ„`;
                statusDiv.style.background = 'rgba(0,200,0,0.2)';
                
                // æ˜¾ç¤ºæ‰‹æŸ„è¯¦æƒ…
                for (let i = 0; i < 4; i++) {
                    if (gamepadManager.isGamepadConnected(i)) {
                        const info = gamepadManager.getGamepadInfo(i);
                        log(`ğŸ® æ‰‹æŸ„ ${i}: ${info.id}`, 'info');
                    }
                }
            } else {
                statusDiv.innerHTML = 'âŒ æœªæ£€æµ‹åˆ°æ‰‹æŸ„';
                statusDiv.style.background = 'rgba(200,0,0,0.2)';
            }
        }

        // å¼€å§‹æµ‹è¯•
        function startTest() {
            if (testInterval) {
                clearInterval(testInterval);
            }

            testInterval = setInterval(() => {
                if (!gamepadManager) return;

                gamepadManager.update();
                
                // æµ‹è¯•Player 1 (æ‰‹æŸ„0)
                testPlayerInput(1);
                
                // æµ‹è¯•Player 2 (æ‰‹æŸ„1) 
                testPlayerInput(2);
                
            }, 100); // 10Hzæ›´æ–°é¢‘ç‡

            log('ğŸš€ å¼€å§‹å®æ—¶æµ‹è¯•...', 'info');
        }

        // åœæ­¢æµ‹è¯•
        function stopTest() {
            if (testInterval) {
                clearInterval(testInterval);
                testInterval = null;
                log('â¹ï¸ æµ‹è¯•å·²åœæ­¢', 'warning');
            }
        }

        // æµ‹è¯•ç©å®¶è¾“å…¥
        function testPlayerInput(playerIndex) {
            try {
                const input = gamepadManager.getPlayerInput(playerIndex);
                if (!input) return;

                const gamepadIndex = playerIndex - 1;
                
                // æ£€æŸ¥Bé”®
                const bPressed = gamepadManager.isButtonPressed(gamepadIndex, gamepadManager.XBOX_BUTTONS.B);
                const bJustPressed = gamepadManager.isButtonJustPressed(gamepadIndex, gamepadManager.XBOX_BUTTONS.B);
                
                // æ£€æŸ¥RTæ‰³æœº
                const rtPressed = gamepadManager.isTriggerPressed(gamepadIndex, 'RT');
                const rtJustPressed = gamepadManager.isTriggerJustPressed(gamepadIndex, 'RT');
                
                // æ£€æŸ¥å¯¼å¼¹å‘å°„
                const launchMissiles = input.launchMissiles;

                // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
                updateStatus('bKeyStatus', `Bé”®: ${bPressed ? 'ğŸ”´ æŒ‰ä¸‹' : 'âšª æœªæŒ‰ä¸‹'} ${bJustPressed ? 'âš¡ åˆšæŒ‰ä¸‹' : ''}`);
                updateStatus('rtTriggerStatus', `RTæ‰³æœº: ${rtPressed ? 'ğŸ”´ æŒ‰ä¸‹' : 'âšª æœªæŒ‰ä¸‹'} ${rtJustPressed ? 'âš¡ åˆšæŒ‰ä¸‹' : ''}`);
                updateStatus('launchMissileStatus', `å¯¼å¼¹å‘å°„: ${launchMissiles ? 'ğŸš€ è§¦å‘!' : 'â¸ï¸ å¾…å‘½'}`);

                // è®°å½•æŒ‰é”®äº‹ä»¶
                if (bJustPressed) {
                    log(`ğŸ…±ï¸ Player ${playerIndex} Bé”®æŒ‰ä¸‹!`, 'success');
                }
                if (rtJustPressed) {
                    log(`ğŸ¯ Player ${playerIndex} RTæ‰³æœºæŒ‰ä¸‹!`, 'success');
                }
                if (launchMissiles) {
                    log(`ğŸš€ Player ${playerIndex} å¯¼å¼¹å‘å°„è§¦å‘! (B:${bPressed} RT:${rtPressed})`, 'success');
                }

            } catch (error) {
                log(`âŒ Player ${playerIndex} è¾“å…¥æµ‹è¯•é”™è¯¯: ${error.message}`, 'error');
            }
        }

        // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
        function updateStatus(elementId, text) {
            const element = document.getElementById(elementId);
            if (element) {
                element.textContent = text;
            }
        }

        // è®°å½•æ—¥å¿—
        function log(message, type = 'info') {
            const logDiv = document.getElementById('testLog');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = type;
            logEntry.textContent = `[${timestamp}] ${message}`;
            
            logDiv.appendChild(logEntry);
            logDiv.scrollTop = logDiv.scrollHeight;
            
            logCount++;
            if (logCount > 100) {
                // ä¿æŒæ—¥å¿—æ•°é‡åœ¨åˆç†èŒƒå›´
                logDiv.removeChild(logDiv.firstChild);
                logCount--;
            }
        }

        // æ¸…ç©ºæ—¥å¿—
        function clearLog() {
            document.getElementById('testLog').innerHTML = '';
            logCount = 0;
            log('ğŸ“ æ—¥å¿—å·²æ¸…ç©º', 'info');
        }

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', init);

        // é¡µé¢å¸è½½æ—¶æ¸…ç†
        window.addEventListener('beforeunload', () => {
            stopTest();
        });
    </script>
</body>
</html>
